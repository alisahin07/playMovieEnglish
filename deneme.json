// 0) Bekleme fonksiyonu
function sleep(ms) {
  return new Promise(res => setTimeout(res, ms));
}

// 1) Ä°ngilizce cÃ¼mleyi (altyazÄ±yÄ±) gÃ¼venli ÅŸekilde okuyan fonksiyon
async function getCurrentSentenceInfo(maxWaitMs = 4000) {
  const step = 200;
  const attempts = Math.floor(maxWaitMs / step);
  let kara = null;

  // .karaoke-page-content elemanÄ±nÄ± bekle
  for (let i = 0; i < attempts; i++) {
    kara = document.querySelector('.karaoke-page-content');
    if (kara) break;
    await sleep(step);
  }

  if (!kara) {
    console.log("â›” .karaoke-page-content bulunamadÄ± (cÃ¼mle alanÄ± yok).");
    return null;
  }

  // AltyazÄ± metnini al
  let text = (kara.innerText || kara.textContent || "").trim();

  // Fazla boÅŸluklarÄ± dÃ¼zelt
  text = text.replace(/\s+/g, " ").trim();

  // BazÄ± durumlarda buton ikon yazÄ±larÄ± vs. olabilir, son taraftaki 'content_copy' vb. temizle
  text = text.replace(/content_copy$/i, "").trim();

  // Kelimeleri say (en az bir harf iÃ§eren tokenlarÄ± sayÄ±yoruz)
  const words = text
    .split(" ")
    .map(w => w.trim())
    .filter(w => w && /[a-zA-Z]/.test(w));

  const wordCount = words.length;

  console.log(`ğŸ“ CÃ¼mle: "${text}" | Kelime sayÄ±sÄ±: ${wordCount}`);

  return { text, wordCount };
}

// 2) DÄ±ÅŸ â€œDownload videoâ€ butonuna tÄ±klama
function clickOuter() {
  const btn = document.querySelector('.download-current-video-button .overlay-video-info');
  if (!btn) {
    console.log("âŒ DÄ±ÅŸ download butonu bulunamadÄ±.");
    return false;
  }
  btn.click();
  console.log("â¡ Popup aÃ§Ä±lÄ±yor (DÄ±ÅŸ 'Download video' tÄ±klandÄ±)...");
  return true;
}

// 3) Popup iÃ§i "Download Video" butonunu bulup tÄ±kla (retryâ€™li)
async function clickInner(retry = 30) {
  for (let i = 0; i < retry; i++) {
    const btn = document.querySelector(
      '.download-page-popup .download-video-content form.generate-video-form button[type="submit"]'
    );

    if (btn) {
      btn.click();
      console.log("â¬‡ Popup iÃ§indeki 'Download Video' butonuna BASILDI!");
      return true;
    }

    // Popup biraz geÃ§ geliyor olabilir
    await sleep(150);
  }

  console.log("âŒ Popup iÃ§indeki 'Download Video' butonu bulunamadÄ±.");
  return false;
}

// 4) Sonraki videoya geÃ§
function nextVideo() {
  const btn = Array.from(document.querySelectorAll('.control-button img'))
    .find(i => i.src.includes("forward"));
  if (!btn) {
    console.log("âŒ Sonraki (forward) butonu bulunamadÄ±.");
    return false;
  }
  btn.click();
  console.log("â¡ Sonraki videoya geÃ§ildi.");
  return true;
}

// 5) Tek bir videoyu indirme akÄ±ÅŸÄ± (senin Ã§alÄ±ÅŸan kodun)
async function downloadOneVideo() {
  if (!clickOuter()) {
    console.log("âŒ DÄ±ÅŸ download butonu yok, bu video indirilemiyor.");
    return false;
  }

  // Popup'Ä±n gÃ¶rÃ¼nmesi iÃ§in kÃ¼Ã§Ã¼k bekleme
  await sleep(600);

  const ok = await clickInner(); // retry ile iÃ§ butona bas
  if (!ok) return false;

  // TarayÄ±cÄ±nÄ±n indirmeyi baÅŸlatmasÄ± iÃ§in bekleyelim
  await sleep(2500);

  return true;
}

// 6) FÄ°LTRELÄ°: 3â€“5 kelimelik cÃ¼mlelere sahip videolarÄ± indir
async function autoDownloadVideosFiltered(maxDownload = 3, maxLoops = 50) {
  console.log(`\nğŸ¯ Filtre: 3â€“5 kelimelik cÃ¼mleler indirilecek. Hedef indirme sayÄ±sÄ±: ${maxDownload}\n`);

  let downloaded = 0;

  for (let i = 0; i < maxLoops; i++) {
    console.log(`\n===== ğŸ” DÃ¶ngÃ¼ ${i + 1}/${maxLoops} | Åu ana kadar indirilen: ${downloaded} =====`);

    // Ã–nce mevcut videonun cÃ¼mlesini oku
    const info = await getCurrentSentenceInfo();
    if (!info) {
      console.log("âŒ CÃ¼mle okunamadÄ±, sadece sonraki videoya geÃ§iliyor.");
    } else {
      const { text, wordCount } = info;

      if (wordCount >= 3 && wordCount <= 8) {
        console.log("âœ… Kelime sayÄ±sÄ± 3â€“5 arasÄ±nda, bu video indirilecek...");
        const ok = await downloadOneVideo();
        if (!ok) {
          console.log("âŒ Ä°ndirme baÅŸarÄ±sÄ±z oldu, dÃ¶ngÃ¼ durduruluyor.");
          break;
        }
        downloaded++;

        if (downloaded >= maxDownload) {
          console.log(`ğŸ‰ Hedeflenen ${maxDownload} video indirildi. Ä°ÅŸlem bitiyor.`);
          break;
        }
      } else {
        console.log("â­ Kelime sayÄ±sÄ± 3â€“5 deÄŸil, bu videoyu atlÄ±yoruz (indirme yok).");
      }
    }

    // Sonraki videoya geÃ§
    const moved = nextVideo();
    if (!moved) {
      console.log("âŒ Sonraki videoya geÃ§ilemedi, dÃ¶ngÃ¼ durduruluyor.");
      break;
    }

    // Yeni videonun yÃ¼klenmesi + altyazÄ±nÄ±n gelmesi iÃ§in bekleme
    await sleep(1800);
  }

  console.log(`\nâœ… Filtreli indirme tamamlandÄ±. Toplam indirilen video: ${downloaded}`);
}

// 7) Ã‡ALIÅTIR: Ã–rneÄŸin 3 tane uygun video indir
autoDownloadVideosFiltered(30, 180);
